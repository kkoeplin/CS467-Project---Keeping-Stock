{% extends "base.html" %}

{% block title %}Keeping Stock{% endblock %}

{% block content %}
<h1>Smart Inventory Management</h1>

<div id="mainButtons">
    <button class="take-image-btn" id="showCameraBtn" onclick="window.location.href='/items/create'">
        Create Item
    </button>
    <button class="take-image-btn" id="boxBtn">Create Box</button>
    <button class="take-image-btn" id="searchBtn" onclick="window.location.href='/gallery'">Search Items/Boxes</button>
    <button class="take-image-btn" id="scanQrBtn">Scan QR Code</button>
</div>

<!-- Live camera feed (hidden initially) -->
<div id="cameraContainer" style="display:none; margin-top:10px;">
    <video id="cameraFeed" autoplay playsinline></video>
    <br>
    <div id="cameraControls" style="margin-top:10px;"></div>
</div>

<!-- Snapshot gallery -->
<div id="snapshotGallery"></div>

<script>
    const showCameraBtn = document.getElementById('showCameraBtn');
    const scanQrBtn = document.getElementById('scanQrBtn');
    const cameraControls = document.getElementById('cameraControls');
    const video = document.getElementById('cameraFeed');
    const cameraContainer = document.getElementById('cameraContainer');
    const gallery = document.getElementById('snapshotGallery');
    const mainButtons = document.querySelectorAll('#mainButtons button');

    let cameraStarted = false;
    let currentMode = null;
    let mediaStream = null;

    function startCamera(mode) {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                mediaStream = stream;
                video.srcObject = stream;
                cameraContainer.style.display = 'block';
                cameraStarted = true;
                currentMode = mode;

                // Disable all main buttons while camera is active
                mainButtons.forEach(btn => btn.disabled = true);
                mainButtons.forEach(btn => btn.style.opacity = 0.5);

                // Clear previous controls
                cameraControls.innerHTML = '';

                // Only add Capture button if in 'create' mode
                if (mode === 'create') {
                    const captureBtn = document.createElement('button');
                    captureBtn.textContent = 'Capture Image';
                    captureBtn.className = 'take-image-btn';
                    captureBtn.style.marginRight = '10px';
                    captureBtn.addEventListener('click', () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0);

                        const img = document.createElement('img');
                        img.src = canvas.toDataURL('image/png');
                        gallery.appendChild(img);
                    });
                    cameraControls.appendChild(captureBtn);
                }

                // Always add Exit button
                const exitCameraBtn = document.createElement('button');
                exitCameraBtn.textContent = 'Exit Camera';
                exitCameraBtn.className = 'take-image-btn';
                exitCameraBtn.style.backgroundColor = 'red';
                exitCameraBtn.style.color = 'white';
                exitCameraBtn.addEventListener('click', stopCamera);
                cameraControls.appendChild(exitCameraBtn);
            })
            .catch(err => {
                alert('Error accessing camera. Please allow camera permission.\n\n' + err.message);
            });
    }

    function stopCamera() {
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
        }
        video.srcObject = null;
        cameraContainer.style.display = 'none';
        cameraStarted = false;
        currentMode = null;

        // Re-enable main buttons
        mainButtons.forEach(btn => btn.disabled = false);
        mainButtons.forEach(btn => btn.style.opacity = 1);
        cameraControls.innerHTML = '';
    }

    // Scan QR Code button
    scanQrBtn.addEventListener('click', () => {
        if (!cameraStarted) {
            startCamera('scan');
        }
    });
</script>
{% endblock %}